name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Verify project structure
        run: |
          set -e
          ls -la
          test -f pubspec.yaml

      - name: Flutter pub get
        run: flutter pub get

      # Ako nemaš ikonice/splash assete u repu, ova 2 koraka mogu da failuju.
      # Ako si ih sredio – ostavi. Ako opet pravi problem – privremeno komentariši ova 2 koraka.
      - name: Generate app icons
        run: flutter pub run flutter_launcher_icons:main

      - name: Generate native splash
        run: flutter pub run flutter_native_splash:create

      - name: Prepare Android local.properties and disable Gradle watcher
        run: |
          set -e
          FLUTTER_ROOT="$(dirname "$(dirname "$(which flutter)")")"
          echo "Detected FLUTTER_ROOT=$FLUTTER_ROOT"

          mkdir -p android
          # local.properties je potreban Gradle-u da zna gde je Flutter SDK
          cat > android/local.properties <<EOF
flutter.sdk=$FLUTTER_ROOT
sdk.dir=$ANDROID_SDK_ROOT
EOF

          # Isključi Gradle file system watcher (rešava "Already watching path...")
          mkdir -p android
          if [ -f android/gradle.properties ]; then
            grep -q "org.gradle.vfs.watch" android/gradle.properties || echo "org.gradle.vfs.watch=false" >> android/gradle.properties
          else
            echo "org.gradle.vfs.watch=false" > android/gradle.properties
          fi

      - name: Build release APK (Gradle)
        run: |
          set -e
          cd android
          ./gradlew --version
          ./gradlew clean
          ./gradlew :app:assembleRelease --stacktrace

      - name: Locate APK (debug)
        run: |
          set -e
          echo "=== APK candidates ==="
          find . -type f -name "*.apk" -print || true
          echo "=== Flutter default output folder (if exists) ==="
          ls -la build/app/outputs/flutter-apk || true
          echo "=== Gradle default output folder ==="
          ls -la android/app/build/outputs/apk/release || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: |
            android/app/build/outputs/apk/release/*.apk
            build/app/outputs/flutter-apk/*.apk
